@page "/actualizar-serie/{_id}"

@inject ISeriesService SeriesService
@inject ISnackbar Snackbar

<div class="container mt-10 p-10">
    <div class="mb-12">
        <MudText Typo="Typo.h4" Class="CardTitle mb-2">Formulario de actualización de serie</MudText>
        <div class="border-bottom border-2 border-danger mb-4 align-center" style="width: 180px;"></div>
    </div>
    <MudForm @ref="_form" Model="@_serieUpdDto" OnValidSubmit="ActualizarSerieAsync">
        <div class="FormMainContainer p-4 rounded-3 shadow-sm mb-4">
            <div class="row g-3">
                <div class="col-12 col-md-6">
                    <MudTextField Label="Título"
                                  @bind-Value="@_serieUpdDto.title"
                                  Variant="Variant.Outlined"
                                  Class="FormLabel w-100"
                                  Required="true"/>
                </div>
                <div class="col-12 col-md-6">
                    <MudNumericField Label="Rating"
                                     @bind-Value="@_serieUpdDto.rating"
                                     Variant="Variant.Outlined"
                                     Class="FormLabel w-100"
                                     Min="0"
                                     Max="10"
                                     Step="0.1"
                                     Required="true" />
                </div>
            </div>
        </div>

        <div class="d-flex flex-column flex-md-row justify-content-center gap-3 mt-4">
            <MudButton OnClick="ActualizarSerieAsync"
                       StartIcon="@Icons.Material.Filled.Save"
                       Class="FormButton px-4">
                Guardar
            </MudButton>

            <MudButton Class="FormButton"
                       StartIcon="@Icons.Material.Filled.ArrowBackIos"
                       Href=@($"/")>
                Volver
            </MudButton>
        </div>
    </MudForm>
</div>

@code {

    [Parameter]
    public string _id { get; set; }

    private MudForm? _form;
    private bool _isLoading = false;
    private SerieResponseDto _serieResDto = new();
    private SerieUpdateDto _serieUpdDto = new();

    private string message;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _serieResDto = await SeriesService.GetSerieByIdAsync(_id);

            _serieUpdDto = new SerieUpdateDto
                {
                    rating = _serieResDto.rating,
                    title = _serieResDto.title
                };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar datos de la serie: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ActualizarSerieAsync()
    {
        _isLoading = true;
        try
        {
            var response = await SeriesService.UpdateSerieAsync(_id, _serieUpdDto);
            Console.WriteLine(System.Text.Json.JsonSerializer.Serialize(response));
            Snackbar.Add("Serie actualizada correctamente", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al actualizar la serie: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}
